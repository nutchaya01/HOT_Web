<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>platform.html</title>
    <script type="text/javascript"
            src = "../simpleGame.js"></script>
    <script type="text/javascript">
    //character graphics adapted from a character from Smack!
    //by creek23.  original file released via creative commons
    //and available at http://opengameart.org/users/creek23
    
    //blocks are draggable to try new configurations
    
    var scene;
    var character;
    var blocks;
    
    function Character(){
        tCharacter = new Sprite(scene, "character.png", 50, 50);
        tCharacter.setSpeed(0);
        tCharacter.setPosition(100, 400);
        tCharacter.falling = true;
        
        tCharacter.checkKeys = function(){
            if (keysDown[K_LEFT]){
                this.changeXby(-5);
            }
            if (keysDown[K_RIGHT]){
                this.changeXby(5);
            }
            if (keysDown[K_UP]){
                
                if (this.falling == false){
                    this.setImage("characterUp.png");
                    this.y -= 5;
                    this.falling = true;
                    this.addVector(0, 15);
                } // end if
            }else {
                checkFalling();    
            }// end if
        } // end checkKeys
        
        tCharacter.checkGravity = function(){
            if (this.falling){
                this.addVector(180, 1);

                //stop if on floor
                if (this.y >= 550){
                    //character.backup();
                    this.setImage("character.png");
                    this.falling = false;
                    this.setSpeed(0);
                    
                } // end if   
                
            } // end if
        } // end checkGravity
        
        tCharacter.backup = function(){
            //I'm overlapping something I shouldn't share space with
            //back up to where I was before the collision was detected
            X = this.x - this.dx;
            Y = this.y - this.dy;
            this.setPosition(X, Y);
        } // end backup
        
        return tCharacter;
    } // end character def
    
    function Block(){
        tBlock = new Sprite(scene, "block.png", 100, 50);
        
        tBlock.setSpeed(0);
        tBlock.setPosition(200, 560);
        
        tBlock.checkLanding = function(){
            //look for a standard collision first
            if (this.collidesWith(character)){
                if (character.falling){
                //if we're heading down, stop falling
                    character.falling = false;
                    character.setImage("character.png");
                    character.backup();
                    character.setPosition(character.x, this.y - character.height);
                    //character.update();
                } // end if
                //character.backup();
                character.setSpeed(0);
             } // end if
        } // end checkLanding
        
        tBlock.checkDrag = function(){
            //allow the block to be draggable
            if (this.isClicked()){
                this.setPosition(scene.getMouseX(), scene.getMouseY());
            } // end if
            
        } // end checkDrag
        
        return tBlock;
    } // end block def
    
    function makeBlocks(){
        bWidth = 100;
        bHeight = 50;
        blocks = new Array(8)
        for (i = 0; i < blocks.length; i++){
            blocks[i] = new Block();
            blocks[i].setPosition(bWidth * i, 550 - (bHeight * i));
        } // end for loop
    } // end makeBlocks
    
    function updateBlocks(){
        for (i = 0; i < blocks.length; i++){
            blocks[i].checkLanding();
            blocks[i].checkDrag();
            blocks[i].update();
        } // end for
    } // end checkLanding
    
    function checkFalling(){
        //if not touching any of the blocks, set falling to true;
        character.falling = true;
        for (i = 0; i < blocks.length; i++){
            if (character.collidesWith(blocks[i])){
                character.backup();
                character.falling = false;
                character.setImage("character.png");
                
            } // end if
        } // end for
    } // end checkFalling
    
    function init(){
        scene = new Scene();
        character = new Character();
        makeBlocks();        
        scene.start();
    } // end init
    
    function update(){
        scene.clear();
        
        character.checkKeys();
        character.checkGravity();
        updateBlocks();;
        
        character.update();
        
    } // end update
    
    </script>
</head>
<body onload = "init()">
    <div>drag blocks slowly to move them around</div>
</body>
</html>